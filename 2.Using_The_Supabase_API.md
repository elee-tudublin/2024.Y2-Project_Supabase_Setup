# The Supabase API

Use the Supabase API to retrieve data from the database and insert new data.

## Accessing the API

Start by logging into your Supabase account and open the computer events database created in the previous tutorial.

Then choose the API section in the dashboard:

![19.api_doc](assets/19.api_doc.png)

You will see entries for both database tables listed.

1.  Choose computers to open its API.

2.  Choose the Bash option to see how to access the API from a bash script

3.  Choose the **anon key** to set the **apikey** and the authorization header when
    requesting data

4.  Scroll down to the command to ‘**read all rows**’

Note that the API is requested via an HTTP request using the **curl**. Curl is a command line tool used to access web resources –  similar to a web browser but without the GUI.

![Graphical user interface, text, chat or text message Description automatically
generated](./assets/20.api_read_all_rows.png)

## Show computers in the Linux console

Copy the curl command to read all rows, then paste it into your Linux console to execute. If it is not installed on your system use  **```sudo apt update```** and then **```sudo apt install curl```**

![A screenshot of a computer Description automatically generated with medium
confidence](./assets/21.curl_call_api.png)

The command uses curl to request all data from the computers table in your database instance using a URL like this one:
https://hkpphovkobfbjqtqkvwy.supabase.co/rest/v1/computers?select=\* along with some extra parameters such as the **apiKey**.

The data is returned as **JSON (JavaScript Object Notation)** which is a standardised way to represent data so that it can be easily exchanged between different systems.

Try out some of the other API commands which can be found in the Supabase API section. For example, get the data for the computer with **id=4**.

## Adding a new event using the API via Bash

The API can also be used to insert data over HTTP. In this example you will add a new event for one of the computers. This is an example of the type of API call you will need to insert data to the database from your MQTT script.

Choose the events table in the Supabase API section. Then, in the Bash section, find the command to insert a row:

![22.insert_event](assets/22.insert_event.png)



The first red box shows the **curl post request** to the API required to insert a row into the events table,

The second red box sets the content type which will be sent (JSON) and also the data in JSON format (after the **-d** flag)

JSON consists of comma separated name, value pairs enclosed in braces. 

**JSON syntax rules:** 

1. A  JSON object contains one or more  **```"name": "value" ```** pairs - the **```"name"```**  part must be followed by **```:```** then a **```space```** then the **```"value"```**
2. Each pair must be **```,```** separated - no comma after the last pair.
3. The whole **JSON object** must be enclosed by braces **```{  }```**
4. Quotes are not required for numeric **values**, for example **``` { "id": 9 }```** Quoted numbers will be sent as strings and may require conversion before use. names, e.g. ```"id"``` **must** be quoted.

This example shows data for an event as **JSON**. Note that **id** and  **timestamp** are generated by the database and so are not included. 

```json
{
    "computer_id": 3,
    "description": "the server was updated",
    "level": "information",
    "service": "postgres",
    "type": "system update",
    "user": "database" 
}
```

### Inserting an Event

1.  Build the JSON to insert a new event for the computer with **```"computer_id": 3```**
2.  Execute the command from the Linux console
3.  Select all events to verify that a new row was inserted.

Here is an example command. **Make sure to the URL and API key for your database** or it will not work.

```bash
curl -X POST 'https://hkpphovkobfbjqtqkvwy.supabase.co/rest/v1/events' \
-H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYyMDEyOTgzMCwiZXhwIjoxOTM1NzA1ODMwfQ.oCacU8SVPF-Oj0EEaWo8jRw8-oDL_6mAhyP1y_bJyPE" \
-H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYyMDEyOTgzMCwiZXhwIjoxOTM1NzA1ODMwfQ.oCacU8SVPF-Oj0EEaWo8jRw8-oDL_6mAhyP1y_bJyPE" \
-H "Content-Type: application/json" \
-d '{
    "computer_id": 3,
    "description": "the server was updated",
    "level": "information",
    "service": "postgres",
    "type": "system update",
    "user": "database" 
}'
```

##### The Linux console

<img src="./assets/23.bash_insert_select_all.png" style="zoom:60%;" alt="Linux console"/>



##### In Supabase (Table view)

![supabase events](./assets/24.supabase_events_table.png)



##### In Supabase (SQL view)

![supabase events sql](./assets/25.supabase_events_sql.png)



------

**Enda Lee 2024**

